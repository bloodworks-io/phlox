# Use an official Python runtime as a parent image
FROM python:3.12-slim

# Set the working directory inside the image
WORKDIR /usr/src/app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy the entire server directory to /usr/src/app/server
COPY server/ /usr/src/app/server/

# Install Python dependencies
RUN pip install --no-cache-dir -r server/requirements.txt
RUN pip install --no-cache-dir pytest pytest-asyncio pytest-cov

# Set environment variable to indicate we're in a test environment
ENV TESTING=true
ENV DB_ENCRYPTION_KEY=test_key_12345

# Create empty build dir
RUN mkdir -p /usr/src/app/build
RUN echo "<html><body>Test</body></html>" > /usr/src/app/build/index.html

# Create the run_tests.sh script
RUN <<'EOF' cat > /usr/src/app/run_tests.sh
#!/bin/bash
# Delete test database if it exists
rm -f /usr/src/app/data/test_phlox_database.sqlite

# Run tests with coverage
pytest --cov=server --cov-report=xml --cov-report=lcov server/tests
test_exit_code=$?

# Delete test database after tests
rm -f /usr/src/app/data/test_phlox_database.sqlite

# Exit with the test exit code
exit $test_exit_code
EOF

RUN chmod +x /usr/src/app/run_tests.sh

# Run tests using the script
CMD ["/usr/src/app/run_tests.sh"]
