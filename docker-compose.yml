version: "3"
services:
    app:
        image: phlox:latest
        container_name: phlox
        ports:
            - "5000:5000"
        environment:
            - DB_ENCRYPTION_KEY= ${DB_ENCRYPTION_KEY}
            - REACT_APP_BACKEND_URL= https://http://localhost:5000/ # Replace with your desired URL
            - TZ=America/Sao_Paulo # Replace with your timezone
        volumes:
            - ./data:/usr/src/app/data # Only for persistent data
            - ./logs:/usr/src/app/logs # Optional: Persist logs
        depends_on:
            - ollama
        networks:
            - phlox-do-taitai-network            
    ollama:
        image: docker.io/ollama/ollama:latest
        container_name: ollama
        restart: always
        pull_policy: always
        ports:
          - 7869:11434
        volumes:
          - ollama-data:/root/.ollama
        environment:
          - OLLAMA_NUM_GPU=1
          - OLLAMA_GPU_MEMORY=4096
        networks:
          - phlox-do-taitai-network 
        deploy:
          resources:
            limits:
              memory: 8G
            reservations:
              devices:
                - driver: nvidia
                  count: 1
                  capabilities: [gpu]
    whisper:
        image: fedirz/faster-whisper-server:latest-cuda
        container_name: phlox-whisper
        restart: unless-stopped
        ports:
          - "8000:8000"
        environment:
          - WHISPER__MODEL=large-v3
          - WHISPER__INFERENCE__DEVICE=cuda
          - WHISPER__INFERENCE__COMPUTE_TYPE=float16
          - WHISPER__INFERENCE__BEAM_SIZE=10
          - WHISPER__INFERENCE__BEST_OF=10
          - WHISPER__INFERENCE__TEMPERATURE=0.0
          - WHISPER__INFERENCE__VAD_FILTER=true
          - WHISPER__INFERENCE__WORD_TIMESTAMPS=true
        volumes:
          - whisper-models:/root/.cache/huggingface
        networks:
          - phlox-do-taitai-network
        deploy:
          resources:
            limits:
              memory: 16G
            reservations:
              devices:
                - driver: nvidia
                  count: 1
                  capabilities: [gpu, compute, utility]
networks:
  phlox-do-taitai-network:
    driver: bridge
